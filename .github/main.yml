name: Main Kittygram Workflow

on:
  push:
    branches: [ main ]

jobs:
  test:
    name: Test and lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'  
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt        
      - name: Run flake8
        run: |
          cd backend
          flake8 .
  deploy:
    name: Deploy to production server
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Copy docker-compose.production.yml to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          source: "docker-compose.production.yml"
          target: "~/kittygram/"
          strip_components: 0
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            cd ~/kittygram
            echo "Pulling latest images..."
            docker compose -f docker-compose.production.yml pull
            echo "Starting containers..."
            docker compose -f docker-compose.production.yml up -d
            sleep 5
            echo "Running migrations..."
            docker compose -f docker-compose.production.yml exec backend python manage.py migrate --noinput
            echo "Collecting static files..."
            docker compose -f docker-compose.production.yml exec backend python manage.py collectstatic --noinput
            echo "Copying static files to shared volume..."
            docker compose -f docker-compose.production.yml exec backend cp -r /backend_static/. /static/static/
            echo "Copying media files to shared volume..."
            docker compose -f docker-compose.production.yml exec backend cp -r /backend_media/. /media/
            echo "Deployment completed!"
  notify:
    name: Send Telegram notification
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Send Telegram message
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            STATUS="✅ Успешный деплой kittygram"
          else
            STATUS="❌ Ошибка при деплое kittygram"
          fi
          TEXT="${STATUS}%0ARepo: $GITHUB_REPOSITORY%0ACommit: $GITHUB_SHA"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_TO }}" \
            -d text="$TEXT"